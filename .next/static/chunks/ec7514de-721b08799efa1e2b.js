(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[224],{575:function(t,e,n){!function(t){"use strict";ArrayBuffer.isView||(ArrayBuffer.isView=function(t){return null!==t&&"object"==typeof t&&t.buffer instanceof ArrayBuffer}),"undefined"==typeof globalThis&&"undefined"!=typeof window&&(window.globalThis=window);var e,i,r,o,s,a,c,f,u,h,d=function(t,e){return(d=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function l(t,e){if("function"!=typeof e&&null!==e)throw TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}d(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function p(t,e,n,i){return new(n||(n=Promise))(function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):((e=t.value)instanceof n?e:new n(function(t){t(e)})).then(s,a)}c((i=i.apply(t,e||[])).next())})}function v(t,e){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(c){return function(a){if(n)throw TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(n=1,i&&(r=2&a[0]?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,i=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===a[0]||2===a[0])){s=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){s.label=a[1];break}if(6===a[0]&&s.label<r[1]){s.label=r[1],r=a;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(a);break}r[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],i=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}function y(t,e){e.statusMessage=t.statusText,e.statusCode=t.status,e.data=t.body}function g(t,e,n){var i,r,o=(n=n||{}).body;return n.method=t,n.headers=n.headers||{},o instanceof FormData||o&&"object"==typeof o&&(n.headers["content-type"]="application/json",n.body=JSON.stringify(o)),n.withCredentials&&(n.credentials="include"),n.timeout&&(r=new AbortController,n.signal=r.signal,i=setTimeout(r.abort,n.timeout)),new Promise((t,s)=>{fetch(e,n).then((e,r)=>{clearTimeout(i),y(e,e),r=e.status>=400?s:t,(o=e.headers.get("content-type"))&&~o.indexOf("application/json")?e.text().then(t=>{try{e.data=JSON.parse(t,n.reviver),r(e)}catch(t){t.headers=e.headers,y(e,t),s(t)}}):r(e)}).catch(t=>{t.timeout=r&&r.signal.aborted,s(t)})})}var m=g.bind(g,"GET"),E=g.bind(g,"POST"),A=g.bind(g,"PATCH"),_=g.bind(g,"DELETE"),O=g.bind(g,"PUT"),$={del:_,get:m,patch:A,post:E,put:O,send:g},w=(i={__proto__:null,default:$,del:_,get:m,patch:A,post:E,put:O,send:g},[$].forEach(function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach(function(e){if("default"!==e&&!(e in i)){var n=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(i,e,n.get?n:{enumerable:!0,get:function(){return t[e]}})}})}),Object.freeze(i));(r=f||(f={}))[r.CONSENTED=4e3]="CONSENTED",r[r.DEVMODE_RESTART=4010]="DEVMODE_RESTART";var b=function(t){function e(e,n){var i=t.call(this,n)||this;return i.name="ServerError",i.code=e,i}return l(e,t),e}(Error);function I(t,e){if(this._offset=e,t instanceof ArrayBuffer)this._buffer=t,this._view=new DataView(this._buffer);else if(ArrayBuffer.isView(t))this._buffer=t.buffer,this._view=new DataView(this._buffer,t.byteOffset,t.byteLength);else throw Error("Invalid argument")}I.prototype._array=function(t){for(var e=Array(t),n=0;n<t;n++)e[n]=this._parse();return e},I.prototype._map=function(t){for(var e={},n=0;n<t;n++)e[this._parse()]=this._parse();return e},I.prototype._str=function(t){var e=function(t,e,n){for(var i="",r=0,o=e,s=e+n;o<s;o++){var a=t.getUint8(o);if((128&a)==0){i+=String.fromCharCode(a);continue}if((224&a)==192){i+=String.fromCharCode((31&a)<<6|63&t.getUint8(++o));continue}if((240&a)==224){i+=String.fromCharCode((15&a)<<12|(63&t.getUint8(++o))<<6|(63&t.getUint8(++o))<<0);continue}if((248&a)==240){(r=(7&a)<<18|(63&t.getUint8(++o))<<12|(63&t.getUint8(++o))<<6|(63&t.getUint8(++o))<<0)>=65536?(r-=65536,i+=String.fromCharCode((r>>>10)+55296,(1023&r)+56320)):i+=String.fromCharCode(r);continue}throw Error("Invalid byte "+a.toString(16))}return i}(this._view,this._offset,t);return this._offset+=t,e},I.prototype._bin=function(t){var e=this._buffer.slice(this._offset,this._offset+t);return this._offset+=t,e},I.prototype._parse=function(){var t,e=this._view.getUint8(this._offset++),n=0,i=0,r=0,o=0;if(e<192)return e<128?e:e<144?this._map(15&e):e<160?this._array(15&e):this._str(31&e);if(e>223)return-((255-e+1)*1);switch(e){case 192:return null;case 194:return!1;case 195:return!0;case 196:return n=this._view.getUint8(this._offset),this._offset+=1,this._bin(n);case 197:return n=this._view.getUint16(this._offset),this._offset+=2,this._bin(n);case 198:return n=this._view.getUint32(this._offset),this._offset+=4,this._bin(n);case 199:if(n=this._view.getUint8(this._offset),i=this._view.getInt8(this._offset+1),this._offset+=2,-1===i){var s=this._view.getUint32(this._offset);return r=this._view.getInt32(this._offset+4),o=this._view.getUint32(this._offset+8),this._offset+=12,new Date((4294967296*r+o)*1e3+s/1e6)}return[i,this._bin(n)];case 200:return n=this._view.getUint16(this._offset),i=this._view.getInt8(this._offset+2),this._offset+=3,[i,this._bin(n)];case 201:return n=this._view.getUint32(this._offset),i=this._view.getInt8(this._offset+4),this._offset+=5,[i,this._bin(n)];case 202:return t=this._view.getFloat32(this._offset),this._offset+=4,t;case 203:return t=this._view.getFloat64(this._offset),this._offset+=8,t;case 204:return t=this._view.getUint8(this._offset),this._offset+=1,t;case 205:return t=this._view.getUint16(this._offset),this._offset+=2,t;case 206:return t=this._view.getUint32(this._offset),this._offset+=4,t;case 207:return r=4294967296*this._view.getUint32(this._offset),o=this._view.getUint32(this._offset+4),this._offset+=8,r+o;case 208:return t=this._view.getInt8(this._offset),this._offset+=1,t;case 209:return t=this._view.getInt16(this._offset),this._offset+=2,t;case 210:return t=this._view.getInt32(this._offset),this._offset+=4,t;case 211:return r=4294967296*this._view.getInt32(this._offset),o=this._view.getUint32(this._offset+4),this._offset+=8,r+o;case 212:if(i=this._view.getInt8(this._offset),this._offset+=1,0===i){this._offset+=1;return}return[i,this._bin(1)];case 213:return i=this._view.getInt8(this._offset),this._offset+=1,[i,this._bin(2)];case 214:if(i=this._view.getInt8(this._offset),this._offset+=1,-1===i)return t=this._view.getUint32(this._offset),this._offset+=4,new Date(1e3*t);return[i,this._bin(4)];case 215:if(i=this._view.getInt8(this._offset),this._offset+=1,0===i)return r=4294967296*this._view.getInt32(this._offset),o=this._view.getUint32(this._offset+4),this._offset+=8,new Date(r+o);if(-1===i){r=this._view.getUint32(this._offset),o=this._view.getUint32(this._offset+4),this._offset+=8;var a=(3&r)*4294967296+o;return new Date(1e3*a+(r>>>2)/1e6)}return[i,this._bin(8)];case 216:return i=this._view.getInt8(this._offset),this._offset+=1,[i,this._bin(16)];case 217:return n=this._view.getUint8(this._offset),this._offset+=1,this._str(n);case 218:return n=this._view.getUint16(this._offset),this._offset+=2,this._str(n);case 219:return n=this._view.getUint32(this._offset),this._offset+=4,this._str(n);case 220:return n=this._view.getUint16(this._offset),this._offset+=2,this._array(n);case 221:return n=this._view.getUint32(this._offset),this._offset+=4,this._array(n);case 222:return n=this._view.getUint16(this._offset),this._offset+=2,this._map(n);case 223:return n=this._view.getUint32(this._offset),this._offset+=4,this._map(n)}throw Error("Could not parse")};var T=globalThis.WebSocket||function(){throw Error("ws does not work in the browser. Browser clients must use the native WebSocket object")},x=function(){function t(t){this.events=t}return t.prototype.send=function(t){t instanceof ArrayBuffer?this.ws.send(t):Array.isArray(t)&&this.ws.send(new Uint8Array(t).buffer)},t.prototype.connect=function(t){this.ws=new T(t,this.protocols),this.ws.binaryType="arraybuffer",this.ws.onopen=this.events.onopen,this.ws.onmessage=this.events.onmessage,this.ws.onclose=this.events.onclose,this.ws.onerror=this.events.onerror},t.prototype.close=function(t,e){this.ws.close(t,e)},Object.defineProperty(t.prototype,"isOpen",{get:function(){return this.ws.readyState===T.OPEN},enumerable:!1,configurable:!0}),t}(),R=function(){function t(){this.events={},this.transport=new x(this.events)}return t.prototype.send=function(t){this.transport.send(t)},t.prototype.connect=function(t){this.transport.connect(t)},t.prototype.close=function(t,e){this.transport.close(t,e)},Object.defineProperty(t.prototype,"isOpen",{get:function(){return this.transport.isOpen},enumerable:!1,configurable:!0}),t}();function P(t,e){for(var n=t[e++],i="",r=0,o=e,s=e+n;o<s;o++){var a=t[o];if((128&a)==0){i+=String.fromCharCode(a);continue}if((224&a)==192){i+=String.fromCharCode((31&a)<<6|63&t[++o]);continue}if((240&a)==224){i+=String.fromCharCode((15&a)<<12|(63&t[++o])<<6|(63&t[++o])<<0);continue}if((248&a)==240){(r=(7&a)<<18|(63&t[++o])<<12|(63&t[++o])<<6|(63&t[++o])<<0)>=65536?(r-=65536,i+=String.fromCharCode((r>>>10)+55296,(1023&r)+56320)):i+=String.fromCharCode(r);continue}throw Error("Invalid byte "+a.toString(16))}return i}function C(t){void 0===t&&(t="");for(var e=0,n=0,i=0,r=t.length;i<r;i++)(e=t.charCodeAt(i))<128?n+=1:e<2048?n+=2:e<55296||e>=57344?n+=3:(i++,n+=4);return n+1}t.Protocol=void 0,(o=t.Protocol||(t.Protocol={}))[o.HANDSHAKE=9]="HANDSHAKE",o[o.JOIN_ROOM=10]="JOIN_ROOM",o[o.ERROR=11]="ERROR",o[o.LEAVE_ROOM=12]="LEAVE_ROOM",o[o.ROOM_DATA=13]="ROOM_DATA",o[o.ROOM_STATE=14]="ROOM_STATE",o[o.ROOM_STATE_PATCH=15]="ROOM_STATE_PATCH",o[o.ROOM_DATA_SCHEMA=16]="ROOM_DATA_SCHEMA",o[o.ROOM_DATA_BYTES=17]="ROOM_DATA_BYTES",t.ErrorCode=void 0,(s=t.ErrorCode||(t.ErrorCode={}))[s.MATCHMAKE_NO_HANDLER=4210]="MATCHMAKE_NO_HANDLER",s[s.MATCHMAKE_INVALID_CRITERIA=4211]="MATCHMAKE_INVALID_CRITERIA",s[s.MATCHMAKE_INVALID_ROOM_ID=4212]="MATCHMAKE_INVALID_ROOM_ID",s[s.MATCHMAKE_UNHANDLED=4213]="MATCHMAKE_UNHANDLED",s[s.MATCHMAKE_EXPIRED=4214]="MATCHMAKE_EXPIRED",s[s.AUTH_FAILED=4215]="AUTH_FAILED",s[s.APPLICATION_ERROR=4216]="APPLICATION_ERROR";var D={};function N(t){var e=D[t];if(!e)throw Error("missing serializer: "+t);return e}let k=()=>({events:{},emit(t,...e){(this.events[t]||[]).forEach(t=>t(...e))},on(t,e){return(this.events[t]=this.events[t]||[]).push(e),()=>this.events[t]=(this.events[t]||[]).filter(t=>t!==e)}});var S=function(){function t(){this.handlers=[]}return t.prototype.register=function(t,e){return this.handlers.push(t),this},t.prototype.invoke=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.handlers.forEach(function(n){return n.apply(t,e)})},t.prototype.invokeAsync=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return Promise.all(this.handlers.map(function(n){return n.apply(t,e)}))},t.prototype.remove=function(t){var e=this.handlers.indexOf(t);this.handlers[e]=this.handlers[this.handlers.length-1],this.handlers.pop()},t.prototype.clear=function(){this.handlers=[]},t}();function M(){var t=new S;function e(e){return t.register(e,this===null)}return e.once=function(e){var n=function(){for(var i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];e.apply(this,i),t.remove(n)};t.register(n)},e.remove=function(e){return t.remove(e)},e.invoke=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return t.invoke.apply(t,e)},e.invokeAsync=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return t.invokeAsync.apply(t,e)},e.clear=function(){return t.clear()},e}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self&&self;var L=(e=0,function(t){var e,n=function(t,e){return(n=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function i(t,e){if("function"!=typeof e&&null!==e)throw TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function r(t,e,n,i){var r,o=arguments.length,s=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(s=(o<3?r(s):o>3?r(e,n,s):r(e,n))||s);return o>3&&s&&Object.defineProperty(e,n,s),s}function o(t,e,n){if(n||2==arguments.length)for(var i,r=0,o=e.length;r<o;r++)!i&&r in e||(i||(i=Array.prototype.slice.call(e,0,r)),i[r]=e[r]);return t.concat(i||Array.prototype.slice.call(e))}t.OPERATION=void 0,(e=t.OPERATION||(t.OPERATION={}))[e.ADD=128]="ADD",e[e.REPLACE=0]="REPLACE",e[e.DELETE=64]="DELETE",e[e.DELETE_AND_ADD=192]="DELETE_AND_ADD",e[e.TOUCH=1]="TOUCH",e[e.CLEAR=10]="CLEAR";var s=function(){function e(t,e,n){this.changed=!1,this.changes=new Map,this.allChanges=new Set,this.caches={},this.currentCustomOperation=0,this.ref=t,this.setParent(e,n)}return e.prototype.setParent=function(t,e,n){var i=this;if(this.indexes||(this.indexes=this.ref instanceof tr?this.ref._definition.indexes:{}),this.parent=t,this.parentIndex=n,e){if(this.root=e,this.ref instanceof tr){var r=this.ref._definition;for(var o in r.schema){var s=this.ref[o];if(s&&s.$changes){var a=r.indexes[o];s.$changes.setParent(this.ref,e,a)}}}else"object"==typeof this.ref&&this.ref.forEach(function(t,e){if(t instanceof tr){var n=t.$changes,r=i.ref.$changes.indexes[e];n.setParent(i.ref,i.root,r)}})}},e.prototype.operation=function(t){this.changes.set(--this.currentCustomOperation,t)},e.prototype.change=function(e,n){void 0===n&&(n=t.OPERATION.ADD);var i="number"==typeof e?e:this.indexes[e];this.assertValidIndex(i,e);var r=this.changes.get(i);r&&r.op!==t.OPERATION.DELETE&&r.op!==t.OPERATION.TOUCH||this.changes.set(i,{op:r&&r.op===t.OPERATION.DELETE?t.OPERATION.DELETE_AND_ADD:n,index:i}),this.allChanges.add(i),this.changed=!0,this.touchParents()},e.prototype.touch=function(e){var n="number"==typeof e?e:this.indexes[e];this.assertValidIndex(n,e),this.changes.has(n)||this.changes.set(n,{op:t.OPERATION.TOUCH,index:n}),this.allChanges.add(n),this.touchParents()},e.prototype.touchParents=function(){this.parent&&this.parent.$changes.touch(this.parentIndex)},e.prototype.getType=function(t){if(this.ref._definition){var e=this.ref._definition;return e.schema[e.fieldsByIndex[t]]}var e=this.parent._definition;return Object.values(e.schema[e.fieldsByIndex[this.parentIndex]])[0]},e.prototype.getChildrenFilter=function(){var t=this.parent._definition.childFilters;return t&&t[this.parentIndex]},e.prototype.getValue=function(t){return this.ref.getByIndex(t)},e.prototype.delete=function(e){var n="number"==typeof e?e:this.indexes[e];if(void 0===n){console.warn("@colyseus/schema ".concat(this.ref.constructor.name,": trying to delete non-existing index: ").concat(e," (").concat(n,")"));return}var i=this.getValue(n);this.changes.set(n,{op:t.OPERATION.DELETE,index:n}),this.allChanges.delete(n),delete this.caches[n],i&&i.$changes&&(i.$changes.parent=void 0),this.changed=!0,this.touchParents()},e.prototype.discard=function(e,n){var i=this;void 0===e&&(e=!1),void 0===n&&(n=!1),this.ref instanceof tr||this.changes.forEach(function(e){if(e.op===t.OPERATION.DELETE){var n=i.ref.getIndex(e.index);delete i.indexes[n]}}),this.changes.clear(),this.changed=e,n&&this.allChanges.clear(),this.currentCustomOperation=0},e.prototype.discardAll=function(){var t=this;this.changes.forEach(function(e){var n=t.getValue(e.index);n&&n.$changes&&n.$changes.discardAll()}),this.discard()},e.prototype.cache=function(t,e){this.caches[t]=e},e.prototype.clone=function(){return new e(this.ref,this.parent,this.root)},e.prototype.ensureRefId=function(){void 0===this.refId&&(this.refId=this.root.getNextUniqueId())},e.prototype.assertValidIndex=function(t,e){if(void 0===t)throw Error('ChangeTree: missing index for field "'.concat(e,'"'))},e}();function a(t,e,n,i){return t[e]||(t[e]=[]),t[e].push(n),null==i||i.forEach(function(t,e){return n(t,e)}),function(){return f(t[e],t[e].indexOf(n))}}function c(e){var n=this,i="string"!=typeof this.$changes.getType();this.$items.forEach(function(r,o){e.push({refId:n.$changes.refId,op:t.OPERATION.DELETE,field:o,value:void 0,previousValue:r}),i&&n.$changes.root.removeRef(r.$changes.refId)})}function f(t,e){if(-1===e||e>=t.length)return!1;for(var n=t.length-1,i=e;i<n;i++)t[i]=t[i+1];return t.length=n,!0}var u=function(t,e){var n=t.toString(),i=e.toString();return n<i?-1:n>i?1:0},h=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.$changes=new s(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,this.push.apply(this,t)}return e.prototype.onAdd=function(e,n){return void 0===n&&(n=!0),a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.ADD,e,n?this.$items:void 0)},e.prototype.onRemove=function(e){return a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.DELETE,e)},e.prototype.onChange=function(e){return a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.REPLACE,e)},e.is=function(t){return Array.isArray(t)||void 0!==t.array},Object.defineProperty(e.prototype,"length",{get:function(){return this.$items.size},set:function(t){0===t?this.clear():this.splice(t,this.length-t)},enumerable:!1,configurable:!0}),e.prototype.push=function(){for(var t,e=this,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];return n.forEach(function(n){t=e.$refId++,e.setAt(t,n)}),t},e.prototype.pop=function(){var t=Array.from(this.$indexes.values()).pop();if(void 0!==t){this.$changes.delete(t),this.$indexes.delete(t);var e=this.$items.get(t);return this.$items.delete(t),e}},e.prototype.at=function(t){var e=Array.from(this.$items.keys())[t];return this.$items.get(e)},e.prototype.setAt=function(e,n){void 0!==n.$changes&&n.$changes.setParent(this,this.$changes.root,e);var i,r,o=null!==(r=null===(i=this.$changes.indexes[e])||void 0===i?void 0:i.op)&&void 0!==r?r:t.OPERATION.ADD;this.$changes.indexes[e]=e,this.$indexes.set(e,e),this.$items.set(e,n),this.$changes.change(e,o)},e.prototype.deleteAt=function(t){var e=Array.from(this.$items.keys())[t];return void 0!==e&&this.$deleteAt(e)},e.prototype.$deleteAt=function(t){return this.$changes.delete(t),this.$indexes.delete(t),this.$items.delete(t)},e.prototype.clear=function(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&c.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:t.OPERATION.CLEAR}),this.$changes.touchParents()},e.prototype.concat=function(){for(var t,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];return new(e.bind.apply(e,o([void 0],(t=Array.from(this.$items.values())).concat.apply(t,n),!1)))},e.prototype.join=function(t){return Array.from(this.$items.values()).join(t)},e.prototype.reverse=function(){var t=this,e=Array.from(this.$items.keys());return Array.from(this.$items.values()).reverse().forEach(function(n,i){t.setAt(e[i],n)}),this},e.prototype.shift=function(){var t=Array.from(this.$items.keys()).shift();if(void 0!==t){var e=this.$items.get(t);return this.$deleteAt(t),e}},e.prototype.slice=function(t,n){var i=new e;return i.push.apply(i,Array.from(this.$items.values()).slice(t,n)),i},e.prototype.sort=function(t){var e=this;void 0===t&&(t=u);var n=Array.from(this.$items.keys());return Array.from(this.$items.values()).sort(t).forEach(function(t,i){e.setAt(n[i],t)}),this},e.prototype.splice=function(t,e){void 0===e&&(e=this.length-t);for(var n=Array.from(this.$items.keys()),i=[],r=t;r<t+e;r++)i.push(this.$items.get(n[r])),this.$deleteAt(n[r]);return i},e.prototype.unshift=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var i=this.length,r=e.length,o=Array.from(this.$items.values());return e.forEach(function(e,n){t.setAt(n,e)}),o.forEach(function(e,n){t.setAt(r+n,e)}),i+r},e.prototype.indexOf=function(t,e){return Array.from(this.$items.values()).indexOf(t,e)},e.prototype.lastIndexOf=function(t,e){return void 0===e&&(e=this.length-1),Array.from(this.$items.values()).lastIndexOf(t,e)},e.prototype.every=function(t,e){return Array.from(this.$items.values()).every(t,e)},e.prototype.some=function(t,e){return Array.from(this.$items.values()).some(t,e)},e.prototype.forEach=function(t,e){Array.from(this.$items.values()).forEach(t,e)},e.prototype.map=function(t,e){return Array.from(this.$items.values()).map(t,e)},e.prototype.filter=function(t,e){return Array.from(this.$items.values()).filter(t,e)},e.prototype.reduce=function(t,e){return Array.prototype.reduce.apply(Array.from(this.$items.values()),arguments)},e.prototype.reduceRight=function(t,e){return Array.prototype.reduceRight.apply(Array.from(this.$items.values()),arguments)},e.prototype.find=function(t,e){return Array.from(this.$items.values()).find(t,e)},e.prototype.findIndex=function(t,e){return Array.from(this.$items.values()).findIndex(t,e)},e.prototype.fill=function(t,e,n){throw Error("ArraySchema#fill() not implemented")},e.prototype.copyWithin=function(t,e,n){throw Error("ArraySchema#copyWithin() not implemented")},e.prototype.toString=function(){return this.$items.toString()},e.prototype.toLocaleString=function(){return this.$items.toLocaleString()},e.prototype[Symbol.iterator]=function(){return Array.from(this.$items.values())[Symbol.iterator]()},e.prototype.entries=function(){return this.$items.entries()},e.prototype.keys=function(){return this.$items.keys()},e.prototype.values=function(){return this.$items.values()},e.prototype.includes=function(t,e){return Array.from(this.$items.values()).includes(t,e)},e.prototype.flatMap=function(t,e){throw Error("ArraySchema#flatMap() is not supported.")},e.prototype.flat=function(t){throw Error("ArraySchema#flat() is not supported.")},e.prototype.findLast=function(){var t=Array.from(this.$items.values());return t.findLast.apply(t,arguments)},e.prototype.findLastIndex=function(){var t=Array.from(this.$items.values());return t.findLastIndex.apply(t,arguments)},e.prototype.setIndex=function(t,e){this.$indexes.set(t,e)},e.prototype.getIndex=function(t){return this.$indexes.get(t)},e.prototype.getByIndex=function(t){return this.$items.get(this.$indexes.get(t))},e.prototype.deleteByIndex=function(t){var e=this.$indexes.get(t);this.$items.delete(e),this.$indexes.delete(t)},e.prototype.toArray=function(){return Array.from(this.$items.values())},e.prototype.toJSON=function(){return this.toArray().map(function(t){return"function"==typeof t.toJSON?t.toJSON():t})},e.prototype.clone=function(t){return t?new(e.bind.apply(e,o([void 0],Array.from(this.$items.values()),!1))):new(e.bind.apply(e,o([void 0],this.map(function(t){return t.$changes?t.clone():t}),!1)))},e}(),d=function(){function e(t){var n=this;if(this.$changes=new s(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,t){if(t instanceof Map||t instanceof e)t.forEach(function(t,e){return n.set(e,t)});else for(var i in t)this.set(i,t[i])}}return e.prototype.onAdd=function(e,n){return void 0===n&&(n=!0),a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.ADD,e,n?this.$items:void 0)},e.prototype.onRemove=function(e){return a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.DELETE,e)},e.prototype.onChange=function(e){return a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.REPLACE,e)},e.is=function(t){return void 0!==t.map},e.prototype[Symbol.iterator]=function(){return this.$items[Symbol.iterator]()},Object.defineProperty(e.prototype,Symbol.toStringTag,{get:function(){return this.$items[Symbol.toStringTag]},enumerable:!1,configurable:!0}),e.prototype.set=function(e,n){if(null==n)throw Error("MapSchema#set('".concat(e,"', ").concat(n,"): trying to set ").concat(n," value on '").concat(e,"'."));var i=void 0!==this.$changes.indexes[e],r=i?this.$changes.indexes[e]:this.$refId++,o=i?t.OPERATION.REPLACE:t.OPERATION.ADD,s=void 0!==n.$changes;return s&&n.$changes.setParent(this,this.$changes.root,r),i?s&&this.$items.get(e)!==n&&(o=t.OPERATION.ADD):(this.$changes.indexes[e]=r,this.$indexes.set(r,e)),this.$items.set(e,n),this.$changes.change(e,o),this},e.prototype.get=function(t){return this.$items.get(t)},e.prototype.delete=function(t){return this.$changes.delete(t),this.$items.delete(t)},e.prototype.clear=function(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&c.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:t.OPERATION.CLEAR}),this.$changes.touchParents()},e.prototype.has=function(t){return this.$items.has(t)},e.prototype.forEach=function(t){this.$items.forEach(t)},e.prototype.entries=function(){return this.$items.entries()},e.prototype.keys=function(){return this.$items.keys()},e.prototype.values=function(){return this.$items.values()},Object.defineProperty(e.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),e.prototype.setIndex=function(t,e){this.$indexes.set(t,e)},e.prototype.getIndex=function(t){return this.$indexes.get(t)},e.prototype.getByIndex=function(t){return this.$items.get(this.$indexes.get(t))},e.prototype.deleteByIndex=function(t){var e=this.$indexes.get(t);this.$items.delete(e),this.$indexes.delete(t)},e.prototype.toJSON=function(){var t={};return this.forEach(function(e,n){t[n]="function"==typeof e.toJSON?e.toJSON():e}),t},e.prototype.clone=function(t){var n;return t?n=Object.assign(new e,this):(n=new e,this.forEach(function(t,e){t.$changes?n.set(e,t.clone()):n.set(e,t)})),n},e}(),l={},p=function(){function t(){this.indexes={},this.fieldsByIndex={},this.deprecated={},this.descriptors={}}return t.create=function(e){var n=new t;return n.schema=Object.assign({},e&&e.schema||{}),n.indexes=Object.assign({},e&&e.indexes||{}),n.fieldsByIndex=Object.assign({},e&&e.fieldsByIndex||{}),n.descriptors=Object.assign({},e&&e.descriptors||{}),n.deprecated=Object.assign({},e&&e.deprecated||{}),n},t.prototype.addField=function(t,e){var n=this.getNextFieldIndex();this.fieldsByIndex[n]=t,this.indexes[t]=n,this.schema[t]=Array.isArray(e)?{array:e[0]}:e},t.prototype.hasField=function(t){return void 0!==this.indexes[t]},t.prototype.addFilter=function(t,e){return this.filters||(this.filters={},this.indexesWithFilters=[]),this.filters[this.indexes[t]]=e,this.indexesWithFilters.push(this.indexes[t]),!0},t.prototype.addChildrenFilter=function(t,e){var n=this.indexes[t];if(l[Object.keys(this.schema[t])[0]])return this.childFilters||(this.childFilters={}),this.childFilters[n]=e,!0;console.warn("@filterChildren: field '".concat(t,"' can't have children. Ignoring filter."))},t.prototype.getChildrenFilter=function(t){return this.childFilters&&this.childFilters[this.indexes[t]]},t.prototype.getNextFieldIndex=function(){return Object.keys(this.schema||{}).length},t}(),v=function(){function t(){this.types={},this.schemas=new Map,this.useFilters=!1}return t.prototype.has=function(t){return this.schemas.has(t)},t.prototype.get=function(t){return this.types[t]},t.prototype.add=function(t,e){void 0===e&&(e=this.schemas.size),t._definition=p.create(t._definition),t._typeid=e,this.types[e]=t,this.schemas.set(t,e)},t.create=function(e){return void 0===e&&(e={}),function(n){return e.context||(e.context=new t),g(n,e)}},t}(),y=new v;function g(t,e){return void 0===e&&(e={}),function(n,i){var r=e.context||y,s=n.constructor;if(s._context=r,!t)throw Error("".concat(s.name,': @type() reference provided for "').concat(i,"\" is undefined. Make sure you don't have any circular dependencies."));r.has(s)||r.add(s);var a=s._definition;if(a.addField(i,t),a.descriptors[i]){if(a.deprecated[i])return;try{throw Error("@colyseus/schema: Duplicate '".concat(i,"' definition on '").concat(s.name,"'.\nCheck @type() annotation"))}catch(t){var c=t.stack.split("\n")[4].trim();throw Error("".concat(t.message," ").concat(c))}}var f=h.is(t),u=!f&&d.is(t);if("string"!=typeof t&&!tr.is(t)){var l=Object.values(t)[0];"string"==typeof l||r.has(l)||r.add(l)}if(e.manual){a.descriptors[i]={enumerable:!0,configurable:!0,writable:!0};return}var p="_".concat(i);a.descriptors[p]={enumerable:!1,configurable:!1,writable:!0},a.descriptors[i]={get:function(){return this[p]},set:function(t){if(t!==this[p]){if(null!=t){if(!f||t instanceof h||(t=new(h.bind.apply(h,o([void 0],t,!1)))),!u||t instanceof d||(t=new d(t)),void 0===t.$proxy){var e,n;u?((e=t).$proxy=!0,t=e=new Proxy(e,{get:function(t,e){return"symbol"!=typeof e&&void 0===t[e]?t.get(e):t[e]},set:function(t,e,n){return"symbol"!=typeof e&&-1===e.indexOf("$")&&"onAdd"!==e&&"onRemove"!==e&&"onChange"!==e?t.set(e,n):t[e]=n,!0},deleteProperty:function(t,e){return t.delete(e),!0}})):f&&((n=t).$proxy=!0,t=n=new Proxy(n,{get:function(t,e){return"symbol"==typeof e||isNaN(e)?t[e]:t.at(e)},set:function(t,e,n){if("symbol"==typeof e||isNaN(e))t[e]=n;else{var i=parseInt(Array.from(t.$items.keys())[e]||e);null==n?t.deleteAt(i):t.setAt(i,n)}return!0},deleteProperty:function(t,e){return"number"==typeof e?t.deleteAt(e):delete t[e],!0}}))}this.$changes.change(i),t.$changes&&t.$changes.setParent(this,this.$changes.root,this._definition.indexes[i])}else this[p]&&this.$changes.delete(i);this[p]=t}},enumerable:!0,configurable:!0}}}function m(t,e,n){for(var i=0,r=0,o=n.length;r<o;r++)(i=n.charCodeAt(r))<128?t[e++]=i:i<2048?(t[e++]=192|i>>6,t[e++]=128|63&i):i<55296||i>=57344?(t[e++]=224|i>>12,t[e++]=128|i>>6&63,t[e++]=128|63&i):(r++,i=65536+((1023&i)<<10|1023&n.charCodeAt(r)),t[e++]=240|i>>18,t[e++]=128|i>>12&63,t[e++]=128|i>>6&63,t[e++]=128|63&i)}function E(t,e){t.push(255&e)}function A(t,e){t.push(255&e)}function _(t,e){t.push(255&e),t.push(e>>8&255)}function O(t,e){t.push(255&e),t.push(e>>8&255)}function $(t,e){t.push(255&e),t.push(e>>8&255),t.push(e>>16&255),t.push(e>>24&255)}function w(t,e){var n=e>>24,i=e>>16,r=e>>8;t.push(255&e),t.push(255&r),t.push(255&i),t.push(255&n)}function b(t,e){w(t,e>>>0),w(t,Math.floor(e/4294967296))}function I(t,e){w(t,e>>>0),w(t,e/4294967296>>0)}var T=new Int32Array(2),x=new Float32Array(T.buffer),R=new Float64Array(T.buffer);function P(t,e){x[0]=e,$(t,T[0])}function C(t,e){R[0]=e,$(t,T[0]),$(t,T[1])}function D(t,e){e||(e="");var n=function(t){for(var e=0,n=0,i=0,r=t.length;i<r;i++)(e=t.charCodeAt(i))<128?n+=1:e<2048?n+=2:e<55296||e>=57344?n+=3:(i++,n+=4);return n}(e),i=0;if(n<32)t.push(160|n),i=1;else if(n<256)t.push(217),A(t,n),i=2;else if(n<65536)t.push(218),O(t,n),i=3;else if(n<4294967296)t.push(219),w(t,n),i=5;else throw Error("String too long");return m(t,t.length,e),i+n}function N(t,e){return isNaN(e)?N(t,0):isFinite(e)?e!==(0|e)?(t.push(203),C(t,e),9):e>=0?e<128?(A(t,e),1):e<256?(t.push(204),A(t,e),2):e<65536?(t.push(205),O(t,e),3):e<4294967296?(t.push(206),w(t,e),5):(t.push(207),I(t,e),9):e>=-32?(t.push(224|e+32),1):e>=-128?(t.push(208),E(t,e),2):e>=-32768?(t.push(209),_(t,e),3):e>=-2147483648?(t.push(210),$(t,e),5):(t.push(211),b(t,e),9):N(t,e>0?Number.MAX_SAFE_INTEGER:-Number.MAX_SAFE_INTEGER)}var k=Object.freeze({__proto__:null,utf8Write:m,int8:E,uint8:A,int16:_,uint16:O,int32:$,uint32:w,int64:b,uint64:I,float32:function(t,e){P(t,e)},float64:function(t,e){C(t,e)},writeFloat32:P,writeFloat64:C,boolean:function(t,e){return A(t,e?1:0)},string:D,number:N});function S(t,e){return M(t,e)<<24>>24}function M(t,e){return t[e.offset++]}function L(t,e){return U(t,e)<<16>>16}function U(t,e){return t[e.offset++]|t[e.offset++]<<8}function j(t,e){return t[e.offset++]|t[e.offset++]<<8|t[e.offset++]<<16|t[e.offset++]<<24}function F(t,e){return j(t,e)>>>0}function H(t,e){var n=F(t,e);return 4294967296*j(t,e)+n}function B(t,e){var n=F(t,e);return 4294967296*F(t,e)+n}var V=new Int32Array(2),z=new Float32Array(V.buffer),J=new Float64Array(V.buffer);function q(t,e){return V[0]=j(t,e),z[0]}function K(t,e){return V[0]=j(t,e),V[1]=j(t,e),J[0]}function W(t,e){var n,i=t[e.offset++];i<192?n=31&i:217===i?n=M(t,e):218===i?n=U(t,e):219===i&&(n=F(t,e));var r=function(t,e,n){for(var i="",r=0,o=e,s=e+n;o<s;o++){var a=t[o];if((128&a)==0){i+=String.fromCharCode(a);continue}if((224&a)==192){i+=String.fromCharCode((31&a)<<6|63&t[++o]);continue}if((240&a)==224){i+=String.fromCharCode((15&a)<<12|(63&t[++o])<<6|(63&t[++o])<<0);continue}if((248&a)==240){(r=(7&a)<<18|(63&t[++o])<<12|(63&t[++o])<<6|(63&t[++o])<<0)>=65536?(r-=65536,i+=String.fromCharCode((r>>>10)+55296,(1023&r)+56320)):i+=String.fromCharCode(r);continue}console.error("Invalid byte "+a.toString(16))}return i}(t,e.offset,n);return e.offset+=n,r}function Y(t,e){var n=t[e.offset++];if(n<128)return n;if(202===n)return q(t,e);if(203===n)return K(t,e);if(204===n)return M(t,e);if(205===n)return U(t,e);if(206===n)return F(t,e);if(207===n)return B(t,e);else if(208===n)return S(t,e);else if(209===n)return L(t,e);else if(210===n)return j(t,e);else if(211===n)return H(t,e);else if(n>223)return-((255-n+1)*1)}function G(t,e){return 255===t[e.offset-1]&&(t[e.offset]<128||t[e.offset]>=202&&t[e.offset]<=211)}var X=Object.freeze({__proto__:null,int8:S,uint8:M,int16:L,uint16:U,int32:j,uint32:F,float32:function(t,e){return q(t,e)},float64:function(t,e){return K(t,e)},int64:H,uint64:B,readFloat32:q,readFloat64:K,boolean:function(t,e){return M(t,e)>0},string:W,stringCheck:function(t,e){var n=t[e.offset];return n<192&&n>160||217===n||218===n||219===n},number:Y,numberCheck:function(t,e){var n=t[e.offset];return n<128||n>=202&&n<=211},arrayCheck:function(t,e){return t[e.offset]<160},switchStructureCheck:G}),Q=function(){function e(t){var e=this;this.$changes=new s(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,t&&t.forEach(function(t){return e.add(t)})}return e.prototype.onAdd=function(e,n){return void 0===n&&(n=!0),a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.ADD,e,n?this.$items:void 0)},e.prototype.onRemove=function(e){return a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.DELETE,e)},e.prototype.onChange=function(e){return a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.REPLACE,e)},e.is=function(t){return void 0!==t.collection},e.prototype.add=function(t){var e=this.$refId++;return void 0!==t.$changes&&t.$changes.setParent(this,this.$changes.root,e),this.$changes.indexes[e]=e,this.$indexes.set(e,e),this.$items.set(e,t),this.$changes.change(e),e},e.prototype.at=function(t){var e=Array.from(this.$items.keys())[t];return this.$items.get(e)},e.prototype.entries=function(){return this.$items.entries()},e.prototype.delete=function(t){for(var e,n,i=this.$items.entries();(n=i.next())&&!n.done;)if(t===n.value[1]){e=n.value[0];break}return void 0!==e&&(this.$changes.delete(e),this.$indexes.delete(e),this.$items.delete(e))},e.prototype.clear=function(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&c.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:t.OPERATION.CLEAR}),this.$changes.touchParents()},e.prototype.has=function(t){return Array.from(this.$items.values()).some(function(e){return e===t})},e.prototype.forEach=function(t){var e=this;this.$items.forEach(function(n,i,r){return t(n,i,e)})},e.prototype.values=function(){return this.$items.values()},Object.defineProperty(e.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),e.prototype.setIndex=function(t,e){this.$indexes.set(t,e)},e.prototype.getIndex=function(t){return this.$indexes.get(t)},e.prototype.getByIndex=function(t){return this.$items.get(this.$indexes.get(t))},e.prototype.deleteByIndex=function(t){var e=this.$indexes.get(t);this.$items.delete(e),this.$indexes.delete(t)},e.prototype.toArray=function(){return Array.from(this.$items.values())},e.prototype.toJSON=function(){var t=[];return this.forEach(function(e,n){t.push("function"==typeof e.toJSON?e.toJSON():e)}),t},e.prototype.clone=function(t){var n;return t?n=Object.assign(new e,this):(n=new e,this.forEach(function(t){t.$changes?n.add(t.clone()):n.add(t)})),n},e}(),Z=function(){function e(t){var e=this;this.$changes=new s(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,t&&t.forEach(function(t){return e.add(t)})}return e.prototype.onAdd=function(e,n){return void 0===n&&(n=!0),a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.ADD,e,n?this.$items:void 0)},e.prototype.onRemove=function(e){return a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.DELETE,e)},e.prototype.onChange=function(e){return a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.REPLACE,e)},e.is=function(t){return void 0!==t.set},e.prototype.add=function(e){if(this.has(e))return!1;var n,i,r=this.$refId++;void 0!==e.$changes&&e.$changes.setParent(this,this.$changes.root,r);var o=null!==(i=null===(n=this.$changes.indexes[r])||void 0===n?void 0:n.op)&&void 0!==i?i:t.OPERATION.ADD;return this.$changes.indexes[r]=r,this.$indexes.set(r,r),this.$items.set(r,e),this.$changes.change(r,o),r},e.prototype.entries=function(){return this.$items.entries()},e.prototype.delete=function(t){for(var e,n,i=this.$items.entries();(n=i.next())&&!n.done;)if(t===n.value[1]){e=n.value[0];break}return void 0!==e&&(this.$changes.delete(e),this.$indexes.delete(e),this.$items.delete(e))},e.prototype.clear=function(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&c.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:t.OPERATION.CLEAR}),this.$changes.touchParents()},e.prototype.has=function(t){for(var e,n=this.$items.values(),i=!1;(e=n.next())&&!e.done;)if(t===e.value){i=!0;break}return i},e.prototype.forEach=function(t){var e=this;this.$items.forEach(function(n,i,r){return t(n,i,e)})},e.prototype.values=function(){return this.$items.values()},Object.defineProperty(e.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),e.prototype.setIndex=function(t,e){this.$indexes.set(t,e)},e.prototype.getIndex=function(t){return this.$indexes.get(t)},e.prototype.getByIndex=function(t){return this.$items.get(this.$indexes.get(t))},e.prototype.deleteByIndex=function(t){var e=this.$indexes.get(t);this.$items.delete(e),this.$indexes.delete(t)},e.prototype.toArray=function(){return Array.from(this.$items.values())},e.prototype.toJSON=function(){var t=[];return this.forEach(function(e,n){t.push("function"==typeof e.toJSON?e.toJSON():e)}),t},e.prototype.clone=function(t){var n;return t?n=Object.assign(new e,this):(n=new e,this.forEach(function(t){t.$changes?n.add(t.clone()):n.add(t)})),n},e}(),tt=function(){function t(){this.refIds=new WeakSet,this.containerIndexes=new WeakMap}return t.prototype.addRefId=function(t){this.refIds.has(t)||(this.refIds.add(t),this.containerIndexes.set(t,new Set))},t.get=function(e){return void 0===e.$filterState&&(e.$filterState=new t),e.$filterState},t}(),te=function(){function t(){this.refs=new Map,this.refCounts={},this.deletedRefs=new Set,this.nextUniqueId=0}return t.prototype.getNextUniqueId=function(){return this.nextUniqueId++},t.prototype.addRef=function(t,e,n){void 0===n&&(n=!0),this.refs.set(t,e),n&&(this.refCounts[t]=(this.refCounts[t]||0)+1)},t.prototype.removeRef=function(t){this.refCounts[t]=this.refCounts[t]-1,this.deletedRefs.add(t)},t.prototype.clearRefs=function(){this.refs.clear(),this.deletedRefs.clear(),this.refCounts={}},t.prototype.garbageCollectDeletedRefs=function(){var t=this;this.deletedRefs.forEach(function(e){if(!(t.refCounts[e]>0)){var n=t.refs.get(e);if(n instanceof tr)for(var i in n._definition.schema)"string"!=typeof n._definition.schema[i]&&n[i]&&n[i].$changes&&t.removeRef(n[i].$changes.refId);else{var r=n.$changes.parent._definition;"function"==typeof Object.values(r.schema[r.fieldsByIndex[n.$changes.parentIndex]])[0]&&Array.from(n.values()).forEach(function(e){return t.removeRef(e.$changes.refId)})}t.refs.delete(e),delete t.refCounts[e]}}),this.deletedRefs.clear()},t}(),tn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e}(Error);function ti(t,e,n,i){if(!(t instanceof e))throw new tn("a '".concat(e.name,"' was expected, but '").concat(t.constructor.name,"' was provided in ").concat(n.constructor.name,"#").concat(i))}var tr=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];Object.defineProperties(this,{$changes:{value:new s(this,void 0,new te),enumerable:!1,writable:!0},$callbacks:{value:void 0,enumerable:!1,writable:!0}});var n=this._definition.descriptors;n&&Object.defineProperties(this,n),t[0]&&this.assign(t[0])}return e.onError=function(t){console.error(t)},e.is=function(t){return t._definition&&void 0!==t._definition.schema},e.prototype.onChange=function(e){return a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.REPLACE,e)},e.prototype.onRemove=function(e){return a(this.$callbacks||(this.$callbacks=[]),t.OPERATION.DELETE,e)},e.prototype.assign=function(t){return Object.assign(this,t),this},Object.defineProperty(e.prototype,"_definition",{get:function(){return this.constructor._definition},enumerable:!1,configurable:!0}),e.prototype.setDirty=function(t,e){this.$changes.change(t,e)},e.prototype.listen=function(t,e,n){var i=this;return void 0===n&&(n=!0),this.$callbacks||(this.$callbacks={}),this.$callbacks[t]||(this.$callbacks[t]=[]),this.$callbacks[t].push(e),n&&void 0!==this[t]&&e(this[t],void 0),function(){return f(i.$callbacks[t],i.$callbacks[t].indexOf(e))}},e.prototype.decode=function(n,i,r){void 0===i&&(i={offset:0}),void 0===r&&(r=this);var o,s=[],a=this.$changes.root,c=n.length,f=0;for(a.refs.set(f,this);i.offset<c;){var u,p=n[i.offset++];if(255==p){f=Y(n,i);var v=a.refs.get(f);if(!v)throw Error('"refId" not found: '.concat(f));r=v;continue}var y=r.$changes,g=void 0!==r._definition,m=g?p>>6<<6:p;if(m===t.OPERATION.CLEAR){r.clear(s);continue}var E=g?p%(m||255):Y(n,i),A=g?r._definition.fieldsByIndex[E]:"",_=y.getType(E),O=void 0,$=void 0,w=void 0;if(g?$=r["_".concat(A)]:($=r.getByIndex(E),(m&t.OPERATION.ADD)===t.OPERATION.ADD?(w=r instanceof d?W(n,i):E,r.setIndex(E,w)):w=r.getIndex(E)),(m&t.OPERATION.DELETE)===t.OPERATION.DELETE&&(m!==t.OPERATION.DELETE_AND_ADD&&r.deleteByIndex(E),$&&$.$changes&&a.removeRef($.$changes.refId),O=null),void 0===A){console.warn("@colyseus/schema: definition mismatch");for(var b={offset:i.offset};i.offset<c&&!(G(n,i)&&(b.offset=i.offset+1,a.refs.has(Y(n,b))));)i.offset++;continue}if(m===t.OPERATION.DELETE);else if(e.is(_)){var I=Y(n,i);if(O=a.refs.get(I),m!==t.OPERATION.REPLACE){var T=this.getSchemaType(n,i,_);!O&&((O=this.createTypeInstance(T)).$changes.refId=I,$&&(O.$callbacks=$.$callbacks,$.$changes.refId&&I!==$.$changes.refId&&a.removeRef($.$changes.refId))),a.addRef(I,O,O!==$)}}else if("string"==typeof _)u=i,O=X[_](n,u);else{var x=l[Object.keys(_)[0]],R=Y(n,i),P=a.refs.has(R)?$||a.refs.get(R):new x.constructor;if((O=P.clone(!0)).$changes.refId=R,$&&(O.$callbacks=$.$callbacks,$.$changes.refId&&R!==$.$changes.refId)){a.removeRef($.$changes.refId);for(var C=$.entries(),D=void 0;(D=C.next())&&!D.done;){var N=(o=D.value)[0],k=o[1];s.push({refId:R,op:t.OPERATION.DELETE,field:N,value:void 0,previousValue:k})}}a.addRef(R,O,P!==$)}if(null!=O){if(O.$changes&&O.$changes.setParent(y.ref,y.root,E),r instanceof e)r[A]=O;else if(r instanceof d){var N=w;r.$items.set(N,O),r.$changes.allChanges.add(E)}else if(r instanceof h)r.setAt(E,O);else if(r instanceof Q){var S=r.add(O);r.setIndex(E,S)}else if(r instanceof Z){var S=r.add(O);!1!==S&&r.setIndex(E,S)}}$!==O&&s.push({refId:f,op:m,field:A,dynamicIndex:w,value:O,previousValue:$})}return this._triggerChanges(s),a.garbageCollectDeletedRefs(),s},e.prototype.encode=function(n,i,r){void 0===n&&(n=!1),void 0===i&&(i=[]),void 0===r&&(r=!1);for(var o=this.$changes,s=new WeakSet,a=[o],c=1,f=0;f<c;f++){var u=a[f],h=u.ref,p=h instanceof e;u.ensureRefId(),s.add(u),u!==o&&(u.changed||n)&&(A(i,255),N(i,u.refId));for(var v=n?Array.from(u.allChanges):Array.from(u.changes.values()),y=0,g=v.length;y<g;y++){var m=n?{op:t.OPERATION.ADD,index:v[y]}:v[y],E=m.index,_=p?h._definition.fieldsByIndex&&h._definition.fieldsByIndex[E]:E,O=i.length;if(m.op!==t.OPERATION.TOUCH){if(p)A(i,E|m.op);else{if(A(i,m.op),m.op===t.OPERATION.CLEAR)continue;N(i,E)}}if(!p&&(m.op&t.OPERATION.ADD)==t.OPERATION.ADD&&h instanceof d&&D(i,u.ref.$indexes.get(E)),m.op!==t.OPERATION.DELETE){var $=u.getType(E),w=u.getValue(E);if(w&&w.$changes&&!s.has(w.$changes)&&(a.push(w.$changes),w.$changes.ensureRefId(),c++),m.op!==t.OPERATION.TOUCH){if(e.is($))ti(w,$,h,_),N(i,w.$changes.refId),(m.op&t.OPERATION.ADD)===t.OPERATION.ADD&&this.tryEncodeTypeId(i,$,w.constructor);else if("string"==typeof $)!function(t,e,n,i,r){!function(t,e,n,i){var r,o=!1;switch(e){case"number":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":r="number",isNaN(t)&&console.log('trying to encode "NaN" in '.concat(n.constructor.name,"#").concat(i));break;case"string":r="string",o=!0;break;case"boolean":return}if(typeof t!==r&&(!o||o&&null!==t)){var s="'".concat(JSON.stringify(t),"'").concat(t&&t.constructor&&" (".concat(t.constructor.name,")")||"");throw new tn("a '".concat(r,"' was expected, but ").concat(s," was provided in ").concat(n.constructor.name,"#").concat(i))}}(n,t,i,r);var o=k[t];if(o)o(e,n);else throw new tn("a '".concat(t,"' was expected, but ").concat(n," was provided in ").concat(i.constructor.name,"#").concat(r))}($,i,w,h,_);else{var b=l[Object.keys($)[0]];ti(h["_".concat(_)],b.constructor,h,_),N(i,w.$changes.refId)}r&&u.cache(E,i.slice(O))}}}n||r||u.discard()}return i},e.prototype.encodeAll=function(t){return this.encode(!0,[],t)},e.prototype.applyFilters=function(n,i){void 0===i&&(i=!1);for(var r,o,s=this,a=new Set,c=tt.get(n),f=[this.$changes],u=1,h=[],l=0;l<u;l++)!function(l){var p=f[l];if(!a.has(p.refId)){var v=p.ref,y=v instanceof e;A(h,255),N(h,p.refId);var g=c.refIds.has(p),m=i||!g;c.addRefId(p);var E=c.containerIndexes.get(p),_=m?Array.from(p.allChanges):Array.from(p.changes.values());!i&&y&&v._definition.indexesWithFilters&&v._definition.indexesWithFilters.forEach(function(e){!E.has(e)&&p.allChanges.has(e)&&(m?_.push(e):_.push({op:t.OPERATION.ADD,index:e}))});for(var O=0,$=_.length;O<$;O++){var w=m?{op:t.OPERATION.ADD,index:_[O]}:_[O];if(w.op===t.OPERATION.CLEAR){A(h,w.op);continue}var b=w.index;if(w.op===t.OPERATION.DELETE){y?A(h,w.op|b):(A(h,w.op),N(h,b));continue}var I=p.getValue(b),T=p.getType(b);if(y){var x=v._definition.filters&&v._definition.filters[b];if(x&&!x.call(v,n,I,s)){I&&I.$changes&&a.add(I.$changes.refId);continue}}else{var R=p.parent,x=p.getChildrenFilter();if(x&&!x.call(R,n,v.$indexes.get(b),I,s)){I&&I.$changes&&a.add(I.$changes.refId);continue}}if(I.$changes&&(f.push(I.$changes),u++),w.op!==t.OPERATION.TOUCH){if(w.op===t.OPERATION.ADD||y)h.push.apply(h,null!==(r=p.caches[b])&&void 0!==r?r:[]),E.add(b);else if(E.has(b))h.push.apply(h,null!==(o=p.caches[b])&&void 0!==o?o:[]);else{if(E.add(b),A(h,t.OPERATION.ADD),N(h,b),v instanceof d){var P=p.ref.$indexes.get(b);D(h,P)}I.$changes?N(h,I.$changes.refId):k[T](h,I)}}else if(I.$changes&&!y){if(A(h,t.OPERATION.ADD),N(h,b),v instanceof d){var P=p.ref.$indexes.get(b);D(h,P)}N(h,I.$changes.refId)}}}}(l);return h},e.prototype.clone=function(){var t,e=new this.constructor,n=this._definition.schema;for(var i in n)"object"==typeof this[i]&&"function"==typeof(null===(t=this[i])||void 0===t?void 0:t.clone)?e[i]=this[i].clone():e[i]=this[i];return e},e.prototype.toJSON=function(){var t=this._definition.schema,e=this._definition.deprecated,n={};for(var i in t)e[i]||null===this[i]||void 0===this[i]||(n[i]="function"==typeof this[i].toJSON?this[i].toJSON():this["_".concat(i)]);return n},e.prototype.discardAllChanges=function(){this.$changes.discardAll()},e.prototype.getByIndex=function(t){return this[this._definition.fieldsByIndex[t]]},e.prototype.deleteByIndex=function(t){this[this._definition.fieldsByIndex[t]]=void 0},e.prototype.tryEncodeTypeId=function(t,e,n){e._typeid!==n._typeid&&(A(t,213),N(t,n._typeid))},e.prototype.getSchemaType=function(t,e,n){var i;return 213===t[e.offset]&&(e.offset++,i=this.constructor._context.get(Y(t,e))),i||n},e.prototype.createTypeInstance=function(t){var e=new t;return e.$changes.root=this.$changes.root,e},e.prototype._triggerChanges=function(n){for(var i,r,o,s,a,c,f,u,h,d=new Set,l=this.$changes.root.refs,p=0;p<n.length;p++)!function(p){var v=n[p],y=v.refId,g=l.get(y),m=g.$callbacks;if((v.op&t.OPERATION.DELETE)===t.OPERATION.DELETE&&v.previousValue instanceof e&&(null===(r=null===(i=v.previousValue.$callbacks)||void 0===i?void 0:i[t.OPERATION.DELETE])||void 0===r||r.forEach(function(t){return t()})),m){if(g instanceof e){if(!d.has(y))try{null===(o=null==m?void 0:m[t.OPERATION.REPLACE])||void 0===o||o.forEach(function(t){return t(n)})}catch(t){e.onError(t)}try{m.hasOwnProperty(v.field)&&(null===(s=m[v.field])||void 0===s||s.forEach(function(t){return t(v.value,v.previousValue)}))}catch(t){e.onError(t)}}else v.op===t.OPERATION.ADD&&void 0===v.previousValue?null===(a=m[t.OPERATION.ADD])||void 0===a||a.forEach(function(t){var e;return t(v.value,null!==(e=v.dynamicIndex)&&void 0!==e?e:v.field)}):v.op===t.OPERATION.DELETE?void 0!==v.previousValue&&(null===(c=m[t.OPERATION.DELETE])||void 0===c||c.forEach(function(t){var e;return t(v.previousValue,null!==(e=v.dynamicIndex)&&void 0!==e?e:v.field)})):v.op===t.OPERATION.DELETE_AND_ADD&&(void 0!==v.previousValue&&(null===(f=m[t.OPERATION.DELETE])||void 0===f||f.forEach(function(t){var e;return t(v.previousValue,null!==(e=v.dynamicIndex)&&void 0!==e?e:v.field)})),null===(u=m[t.OPERATION.ADD])||void 0===u||u.forEach(function(t){var e;return t(v.value,null!==(e=v.dynamicIndex)&&void 0!==e?e:v.field)})),v.value!==v.previousValue&&(null===(h=m[t.OPERATION.REPLACE])||void 0===h||h.forEach(function(t){var e;return t(v.value,null!==(e=v.dynamicIndex)&&void 0!==e?e:v.field)}));d.add(y)}}(p)},e._definition=p.create(),e}(),to={context:new v},ts=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),r([g("string",to)],e.prototype,"name",void 0),r([g("string",to)],e.prototype,"type",void 0),r([g("number",to)],e.prototype,"referencedType",void 0),e}(tr),ta=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.fields=new h,e}return i(e,t),r([g("number",to)],e.prototype,"id",void 0),r([g([ts],to)],e.prototype,"fields",void 0),e}(tr),tc=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.types=new h,e}return i(e,t),e.encode=function(t){var n=t.constructor,i=new e;i.rootType=n._typeid;var r=n._context.types;for(var o in r){var s=new ta;s.id=Number(o),function(t,e){for(var n in e){var r=new ts;r.name=n;var o=void 0;if("string"==typeof e[n])o=e[n];else{var s=e[n],a=void 0;tr.is(s)?(o="ref",a=e[n]):(o=Object.keys(s)[0],"string"==typeof s[o]?o+=":"+s[o]:a=s[o]),r.referencedType=a?a._typeid:-1}r.type=o,t.fields.push(r)}i.types.push(t)}(s,r[o]._definition.schema)}return i.encodeAll()},e.decode=function(t,n){var r=new v,o=new e;o.decode(t,n);var s=o.types.reduce(function(t,e){var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e}(tr),o=e.id;return t[o]=n,r.add(n,o),t},{});o.types.forEach(function(t){var e=s[t.id];t.fields.forEach(function(t){var n;if(void 0!==t.referencedType){var i=t.type,o=s[t.referencedType];if(!o){var a=t.type.split(":");i=a[0],o=a[1]}"ref"===i?g(o,{context:r})(e.prototype,t.name):g(((n={})[i]=o,n),{context:r})(e.prototype,t.name)}else g(t.type,{context:r})(e.prototype,t.name)})});var a=s[o.rootType],c=new a;for(var f in a._definition.schema){var u=a._definition.schema[f];"string"!=typeof u&&(c[f]="function"==typeof u?new u:new l[Object.keys(u)[0]].constructor)}return c},r([g([ta],to)],e.prototype,"types",void 0),r([g("number",to)],e.prototype,"rootType",void 0),e}(tr);l.map={constructor:d},l.array={constructor:h},l.set={constructor:Z},l.collection={constructor:Q},t.ArraySchema=h,t.CollectionSchema=Q,t.Context=v,t.MapSchema=d,t.Reflection=tc,t.ReflectionField=ts,t.ReflectionType=ta,t.Schema=tr,t.SchemaDefinition=p,t.SetSchema=Z,t.decode=X,t.defineTypes=function(t,e,n){for(var i in void 0===n&&(n={}),n.context||(n.context=t._context||n.context||y),e)g(e[i],n)(t.prototype,i);return t},t.deprecated=function(t){return void 0===t&&(t=!0),function(e,n){var i=e.constructor._definition;i.deprecated[n]=!0,t&&(i.descriptors[n]={get:function(){throw Error("".concat(n," is deprecated."))},set:function(t){},enumerable:!1,configurable:!0})}},t.dumpChanges=function(t){for(var e=[t.$changes],n={},i=0;i<1;i++)!function(t){var i=e[t];i.changes.forEach(function(t){var e=i.ref,r=t.index;n[e._definition?e._definition.fieldsByIndex[r]:e.$indexes.get(r)]=i.getValue(r)})}(i);return n},t.encode=k,t.filter=function(t){return function(e,n){var i=e.constructor;i._definition.addFilter(n,t)&&(i._context.useFilters=!0)}},t.filterChildren=function(t){return function(e,n){var i=e.constructor;i._definition.addChildrenFilter(n,t)&&(i._context.useFilters=!0)}},t.hasFilter=function(t){return t._context&&t._context.useFilters},t.registerType=function(t,e){l[t]=e},t.type=g,Object.defineProperty(t,"__esModule",{value:!0})}((a={exports:{}}).exports),a.exports),U=function(){function e(t,e){var n=this;this.onStateChange=M(),this.onError=M(),this.onLeave=M(),this.onJoin=M(),this.hasJoined=!1,this.onMessageHandlers=k(),this.roomId=null,this.name=t,e&&(this.serializer=new(N("schema")),this.rootSchema=e,this.serializer.state=new e),this.onError(function(t,e){return console.warn("colyseus.js - onError => (".concat(t,") ").concat(e))}),this.onLeave(function(){return n.removeAllListeners()})}return Object.defineProperty(e.prototype,"id",{get:function(){return this.roomId},enumerable:!1,configurable:!0}),e.prototype.connect=function(t,n,i){void 0===i&&(i=this);var r=new R;i.connection=r,r.events.onmessage=e.prototype.onMessageCallback.bind(i),r.events.onclose=function(t){if(!i.hasJoined){console.warn("Room connection was closed unexpectedly (".concat(t.code,"): ").concat(t.reason)),i.onError.invoke(t.code,t.reason);return}t.code===f.DEVMODE_RESTART&&n?n():(i.onLeave.invoke(t.code),i.destroy())},r.events.onerror=function(t){console.warn("Room, onError (".concat(t.code,"): ").concat(t.reason)),i.onError.invoke(t.code,t.reason)},r.connect(t)},e.prototype.leave=function(e){var n=this;return void 0===e&&(e=!0),new Promise(function(i){n.onLeave(function(t){return i(t)}),n.connection?e?n.connection.send([t.Protocol.LEAVE_ROOM]):n.connection.close():n.onLeave.invoke(f.CONSENTED)})},e.prototype.onMessage=function(t,e){return this.onMessageHandlers.on(this.getMessageHandlerKey(t),e)},e.prototype.send=function(e,n){var i,r=[t.Protocol.ROOM_DATA];if("string"==typeof e?L.encode.string(r,e):L.encode.number(r,e),void 0!==n){var o=function(t){var e=[],n=[],i=function t(e,n,i){var r=typeof i,o=0,s=0,a=0,c=0,f=0,u=0;if("string"===r){if((f=function(t){for(var e=0,n=0,i=0,r=t.length;i<r;i++)(e=t.charCodeAt(i))<128?n+=1:e<2048?n+=2:e<55296||e>=57344?n+=3:(i++,n+=4);return n}(i))<32)e.push(160|f),u=1;else if(f<256)e.push(217,f),u=2;else if(f<65536)e.push(218,f>>8,f),u=3;else if(f<4294967296)e.push(219,f>>24,f>>16,f>>8,f),u=5;else throw Error("String too long");return n.push({_str:i,_length:f,_offset:e.length}),u+f}if("number"===r)return Math.floor(i)===i&&isFinite(i)?i>=0?i<128?(e.push(i),1):i<256?(e.push(204,i),2):i<65536?(e.push(205,i>>8,i),3):i<4294967296?(e.push(206,i>>24,i>>16,i>>8,i),5):(a=i/4294967296>>0,c=i>>>0,e.push(207,a>>24,a>>16,a>>8,a,c>>24,c>>16,c>>8,c),9):i>=-32?(e.push(i),1):i>=-128?(e.push(208,i),2):i>=-32768?(e.push(209,i>>8,i),3):i>=-2147483648?(e.push(210,i>>24,i>>16,i>>8,i),5):(a=Math.floor(i/4294967296),c=i>>>0,e.push(211,a>>24,a>>16,a>>8,a,c>>24,c>>16,c>>8,c),9):(e.push(203),n.push({_float:i,_length:8,_offset:e.length}),9);if("object"===r){if(null===i)return e.push(192),1;if(Array.isArray(i)){if((f=i.length)<16)e.push(144|f),u=1;else if(f<65536)e.push(220,f>>8,f),u=3;else if(f<4294967296)e.push(221,f>>24,f>>16,f>>8,f),u=5;else throw Error("Array too large");for(o=0;o<f;o++)u+=t(e,n,i[o]);return u}if(i instanceof Date){var h=i.getTime(),d=Math.floor(h/1e3),l=(h-1e3*d)*1e6;return d>=0&&l>=0&&d<=17179869183?0===l&&d<=4294967295?(e.push(214,255,d>>24,d>>16,d>>8,d),6):(a=d/4294967296,c=4294967295&d,e.push(215,255,l>>22,l>>14,l>>6,a,c>>24,c>>16,c>>8,c),10):(a=Math.floor(d/4294967296),c=d>>>0,e.push(199,12,255,l>>24,l>>16,l>>8,l,a>>24,a>>16,a>>8,a,c>>24,c>>16,c>>8,c),15)}if(i instanceof ArrayBuffer){if((f=i.byteLength)<256)e.push(196,f),u=2;else if(f<65536)e.push(197,f>>8,f),u=3;else if(f<4294967296)e.push(198,f>>24,f>>16,f>>8,f),u=5;else throw Error("Buffer too large");return n.push({_bin:i,_length:f,_offset:e.length}),u+f}if("function"==typeof i.toJSON)return t(e,n,i.toJSON());var p=[],v="",y=Object.keys(i);for(o=0,s=y.length;o<s;o++)void 0!==i[v=y[o]]&&"function"!=typeof i[v]&&p.push(v);if((f=p.length)<16)e.push(128|f),u=1;else if(f<65536)e.push(222,f>>8,f),u=3;else if(f<4294967296)e.push(223,f>>24,f>>16,f>>8,f),u=5;else throw Error("Object too large");for(o=0;o<f;o++)u+=t(e,n,v=p[o])+t(e,n,i[v]);return u}if("boolean"===r)return e.push(i?195:194),1;if("undefined"===r)return e.push(192),1;if("function"==typeof i.toJSON)return t(e,n,i.toJSON());throw Error("Could not encode")}(e,n,t),r=new ArrayBuffer(i),o=new DataView(r),s=0,a=0,c=-1;n.length>0&&(c=n[0]._offset);for(var f,u=0,h=0,d=0,l=e.length;d<l;d++)if(o.setUint8(a+d,e[d]),d+1===c){if(u=(f=n[s])._length,h=a+c,f._bin)for(var p=new Uint8Array(f._bin),v=0;v<u;v++)o.setUint8(h+v,p[v]);else f._str?function(t,e,n){for(var i=0,r=0,o=n.length;r<o;r++)(i=n.charCodeAt(r))<128?t.setUint8(e++,i):i<2048?(t.setUint8(e++,192|i>>6),t.setUint8(e++,128|63&i)):i<55296||i>=57344?(t.setUint8(e++,224|i>>12),t.setUint8(e++,128|i>>6&63),t.setUint8(e++,128|63&i)):(r++,i=65536+((1023&i)<<10|1023&n.charCodeAt(r)),t.setUint8(e++,240|i>>18),t.setUint8(e++,128|i>>12&63),t.setUint8(e++,128|i>>6&63),t.setUint8(e++,128|63&i))}(o,h,f._str):void 0!==f._float&&o.setFloat64(h,f._float);s++,a+=u,n[s]&&(c=n[s]._offset)}return r}(n);(i=new Uint8Array(r.length+o.byteLength)).set(new Uint8Array(r),0),i.set(new Uint8Array(o),r.length)}else i=new Uint8Array(r);this.connection.send(i.buffer)},e.prototype.sendBytes=function(e,n){var i,r=[t.Protocol.ROOM_DATA_BYTES];"string"==typeof e?L.encode.string(r,e):L.encode.number(r,e),(i=new Uint8Array(r.length+(n.byteLength||n.length))).set(new Uint8Array(r),0),i.set(new Uint8Array(n),r.length),this.connection.send(i.buffer)},Object.defineProperty(e.prototype,"state",{get:function(){return this.serializer.getState()},enumerable:!1,configurable:!0}),e.prototype.removeAllListeners=function(){this.onJoin.clear(),this.onStateChange.clear(),this.onError.clear(),this.onLeave.clear(),this.onMessageHandlers.events={}},e.prototype.onMessageCallback=function(e){var n=Array.from(new Uint8Array(e.data)),i=n[0];if(i===t.Protocol.JOIN_ROOM){var r=1,o=P(n,1);if(r+=C(o),this.serializerId=P(n,r),r+=C(this.serializerId),!this.serializer){var s=N(this.serializerId);this.serializer=new s}n.length>r&&this.serializer.handshake&&this.serializer.handshake(n,{offset:r}),this.reconnectionToken="".concat(this.roomId,":").concat(o),this.hasJoined=!0,this.onJoin.invoke(),this.connection.send([t.Protocol.JOIN_ROOM])}else if(i===t.Protocol.ERROR){var a={offset:1},c=L.decode.number(n,a),f=L.decode.string(n,a);this.onError.invoke(c,f)}else if(i===t.Protocol.LEAVE_ROOM)this.leave();else if(i===t.Protocol.ROOM_DATA_SCHEMA){var u={offset:1},h=this.serializer.getState().constructor._context.get(L.decode.number(n,u)),f=new h;f.decode(n,u),this.dispatchMessage(h,f)}else if(i===t.Protocol.ROOM_STATE)n.shift(),this.setState(n);else if(i===t.Protocol.ROOM_STATE_PATCH)n.shift(),this.patch(n);else if(i===t.Protocol.ROOM_DATA){var d={offset:1},h=L.decode.stringCheck(n,d)?L.decode.string(n,d):L.decode.number(n,d),f=n.length>d.offset?function(t,e){void 0===e&&(e=0);var n=new I(t,e),i=n._parse();if(n._offset!==t.byteLength)throw Error(t.byteLength-n._offset+" trailing bytes");return i}(e.data,d.offset):void 0;this.dispatchMessage(h,f)}else if(i===t.Protocol.ROOM_DATA_BYTES){var l={offset:1},h=L.decode.stringCheck(n,l)?L.decode.string(n,l):L.decode.number(n,l);this.dispatchMessage(h,new Uint8Array(n.slice(l.offset)))}},e.prototype.setState=function(t){this.serializer.setState(t),this.onStateChange.invoke(this.serializer.getState())},e.prototype.patch=function(t){this.serializer.patch(t),this.onStateChange.invoke(this.serializer.getState())},e.prototype.dispatchMessage=function(t,e){var n=this.getMessageHandlerKey(t);this.onMessageHandlers.events[n]?this.onMessageHandlers.emit(n,e):this.onMessageHandlers.events["*"]?this.onMessageHandlers.emit("*",t,e):console.warn("colyseus.js: onMessage() not registered for type '".concat(t,"'."))},e.prototype.destroy=function(){this.serializer&&this.serializer.teardown()},e.prototype.getMessageHandlerKey=function(t){switch(typeof t){case"function":return"$".concat(t._typeid);case"string":return t;case"number":return"i".concat(t);default:throw Error("invalid message type.")}},e}(),j=function(t){function e(n,i){var r=t.call(this,n)||this;return r.code=i,Object.setPrototypeOf(r,e.prototype),r}return l(e,t),e}(Error),F="undefined"!=typeof window&&void 0!==(null===(u=null==window?void 0:window.location)||void 0===u?void 0:u.hostname)?"".concat(window.location.protocol.replace("http","ws"),"//").concat(window.location.hostname).concat(window.location.port&&":".concat(window.location.port)):"ws://127.0.0.1:2567",H=function(){function t(t){if(void 0===t&&(t=F),"string"==typeof t){var e=new URL(t),n="https:"===e.protocol||"wss:"===e.protocol,i=Number(e.port||(n?443:80));this.settings={hostname:e.hostname,pathname:"/"!==e.pathname?e.pathname:"",port:i,secure:n}}else void 0===t.port&&(t.port=t.secure?443:80),void 0===t.pathname&&(t.pathname=""),this.settings=t}return t.prototype.joinOrCreate=function(t,e,n){return void 0===e&&(e={}),p(this,void 0,void 0,function(){return v(this,function(i){switch(i.label){case 0:return[4,this.createMatchMakeRequest("joinOrCreate",t,e,n)];case 1:return[2,i.sent()]}})})},t.prototype.create=function(t,e,n){return void 0===e&&(e={}),p(this,void 0,void 0,function(){return v(this,function(i){switch(i.label){case 0:return[4,this.createMatchMakeRequest("create",t,e,n)];case 1:return[2,i.sent()]}})})},t.prototype.join=function(t,e,n){return void 0===e&&(e={}),p(this,void 0,void 0,function(){return v(this,function(i){switch(i.label){case 0:return[4,this.createMatchMakeRequest("join",t,e,n)];case 1:return[2,i.sent()]}})})},t.prototype.joinById=function(t,e,n){return void 0===e&&(e={}),p(this,void 0,void 0,function(){return v(this,function(i){switch(i.label){case 0:return[4,this.createMatchMakeRequest("joinById",t,e,n)];case 1:return[2,i.sent()]}})})},t.prototype.reconnect=function(t,e){return p(this,void 0,void 0,function(){var n,i,r;return v(this,function(o){switch(o.label){case 0:if("string"==typeof t&&"string"==typeof e)throw Error("DEPRECATED: .reconnect() now only accepts 'reconnectionToken' as argument.\nYou can get this token from previously connected `room.reconnectionToken`");return i=(n=t.split(":"))[0],r=n[1],[4,this.createMatchMakeRequest("reconnect",i,{reconnectionToken:r},e)];case 1:return[2,o.sent()]}})})},t.prototype.getAvailableRooms=function(t){return void 0===t&&(t=""),p(this,void 0,void 0,function(){return v(this,function(e){switch(e.label){case 0:return[4,m(this.getHttpEndpoint("".concat(t)),{headers:{Accept:"application/json"}})];case 1:return[2,e.sent().data]}})})},t.prototype.consumeSeatReservation=function(t,e,n){return p(this,void 0,void 0,function(){var i,r,o,s=this;return v(this,function(a){return(i=this.createRoom(t.room.name,e)).roomId=t.room.roomId,i.sessionId=t.sessionId,r={sessionId:i.sessionId},t.reconnectionToken&&(r.reconnectionToken=t.reconnectionToken),o=n||i,i.connect(this.buildEndpoint(t.room,r),t.devMode&&function(){return p(s,void 0,void 0,function(){var n,r,s=this;return v(this,function(a){return console.info("[Colyseus devMode]: ".concat(String.fromCodePoint(128260)," Re-establishing connection with room id '").concat(i.roomId,"'...")),n=0,setTimeout(r=function(){return p(s,void 0,void 0,function(){return v(this,function(s){switch(s.label){case 0:n++,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,this.consumeSeatReservation(t,e,o)];case 2:return s.sent(),console.info("[Colyseus devMode]: ".concat(String.fromCodePoint(9989)," Successfully re-established connection with room '").concat(i.roomId,"'")),[3,4];case 3:return s.sent(),n<8?(console.info("[Colyseus devMode]: ".concat(String.fromCodePoint(128260)," retrying... (").concat(n," out of ").concat(8,")")),setTimeout(r,2e3)):console.info("[Colyseus devMode]: ".concat(String.fromCodePoint(10060)," Failed to reconnect. Is your server running? Please check server logs.")),[3,4];case 4:return[2]}})})},2e3),[2]})})},o),[2,new Promise(function(t,e){var n=function(t,n){return e(new b(t,n))};o.onError.once(n),o.onJoin.once(function(){o.onError.remove(n),t(o)})})]})})},t.prototype.createMatchMakeRequest=function(t,e,n,i,r){return void 0===n&&(n={}),p(this,void 0,void 0,function(){var o;return v(this,function(s){switch(s.label){case 0:return[4,E(this.getHttpEndpoint("".concat(t,"/").concat(e)),{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(n)})];case 1:if((o=s.sent().data).error)throw new j(o.error,o.code);return"reconnect"===t&&(o.reconnectionToken=n.reconnectionToken),[4,this.consumeSeatReservation(o,i,r)];case 2:return[2,s.sent()]}})})},t.prototype.createRoom=function(t,e){return new U(t,e)},t.prototype.buildEndpoint=function(t,e){void 0===e&&(e={});var n=[];for(var i in e)e.hasOwnProperty(i)&&n.push("".concat(i,"=").concat(e[i]));var r=this.settings.secure?"wss://":"ws://";return t.publicAddress?r+="".concat(t.publicAddress):r+="".concat(this.settings.hostname).concat(this.getEndpointPort()).concat(this.settings.pathname),"".concat(r,"/").concat(t.processId,"/").concat(t.roomId,"?").concat(n.join("&"))},t.prototype.getHttpEndpoint=function(t){return void 0===t&&(t=""),"".concat(this.settings.secure?"https":"http","://").concat(this.settings.hostname).concat(this.getEndpointPort()).concat(this.settings.pathname,"/matchmake/").concat(t)},t.prototype.getEndpointPort=function(){return 80!==this.settings.port&&443!==this.settings.port?":".concat(this.settings.port):""},t}();function B(){return h||(h="undefined"!=typeof cc&&cc.sys&&cc.sys.localStorage?cc.sys.localStorage:"undefined"!=typeof window&&window.localStorage?window.localStorage:{cache:{},setItem:function(t,e){this.cache[t]=e},getItem:function(t){this.cache[t]},removeItem:function(t){delete this.cache[t]}}),h}var V="colyseus-auth-token";t.Platform=void 0,(c=t.Platform||(t.Platform={})).ios="ios",c.android="android";var z=function(){function t(t){var e,n,i=this;this._id=void 0,this.username=void 0,this.displayName=void 0,this.avatarUrl=void 0,this.isAnonymous=void 0,this.email=void 0,this.lang=void 0,this.location=void 0,this.timezone=void 0,this.metadata=void 0,this.devices=void 0,this.facebookId=void 0,this.twitterId=void 0,this.googleId=void 0,this.gameCenterId=void 0,this.steamId=void 0,this.friendIds=void 0,this.blockedUserIds=void 0,this.createdAt=void 0,this.updatedAt=void 0,this.token=void 0,this.endpoint=t.replace("ws","http"),e=function(t){return i.token=t},n=B().getItem(V),"undefined"!=typeof Promise&&n instanceof Promise?n.then(function(t){return e(t)}):e(n)}return Object.defineProperty(t.prototype,"hasToken",{get:function(){return!!this.token},enumerable:!1,configurable:!0}),t.prototype.login=function(t){return void 0===t&&(t={}),p(this,void 0,void 0,function(){var e,n,i;return v(this,function(r){switch(r.label){case 0:return e=Object.assign({},t),this.hasToken&&(e.token=this.token),[4,this.request("post","/auth",e)];case 1:var o,s;for(i in n=r.sent(),this.token=n.token,o=V,s=this.token,B().setItem(o,s),n)this.hasOwnProperty(i)&&(this[i]=n[i]);return this.registerPingService(),[2,this]}})})},t.prototype.save=function(){return p(this,void 0,void 0,function(){return v(this,function(t){switch(t.label){case 0:return[4,this.request("put","/auth",{},{username:this.username,displayName:this.displayName,avatarUrl:this.avatarUrl,lang:this.lang,location:this.location,timezone:this.timezone})];case 1:return t.sent(),[2,this]}})})},t.prototype.getFriends=function(){return p(this,void 0,void 0,function(){return v(this,function(t){switch(t.label){case 0:return[4,this.request("get","/friends/all")];case 1:return[2,t.sent()]}})})},t.prototype.getOnlineFriends=function(){return p(this,void 0,void 0,function(){return v(this,function(t){switch(t.label){case 0:return[4,this.request("get","/friends/online")];case 1:return[2,t.sent()]}})})},t.prototype.getFriendRequests=function(){return p(this,void 0,void 0,function(){return v(this,function(t){switch(t.label){case 0:return[4,this.request("get","/friends/requests")];case 1:return[2,t.sent()]}})})},t.prototype.sendFriendRequest=function(t){return p(this,void 0,void 0,function(){return v(this,function(e){switch(e.label){case 0:return[4,this.request("post","/friends/requests",{userId:t})];case 1:return[2,e.sent()]}})})},t.prototype.acceptFriendRequest=function(t){return p(this,void 0,void 0,function(){return v(this,function(e){switch(e.label){case 0:return[4,this.request("put","/friends/requests",{userId:t})];case 1:return[2,e.sent()]}})})},t.prototype.declineFriendRequest=function(t){return p(this,void 0,void 0,function(){return v(this,function(e){switch(e.label){case 0:return[4,this.request("del","/friends/requests",{userId:t})];case 1:return[2,e.sent()]}})})},t.prototype.blockUser=function(t){return p(this,void 0,void 0,function(){return v(this,function(e){switch(e.label){case 0:return[4,this.request("post","/friends/block",{userId:t})];case 1:return[2,e.sent()]}})})},t.prototype.unblockUser=function(t){return p(this,void 0,void 0,function(){return v(this,function(e){switch(e.label){case 0:return[4,this.request("put","/friends/block",{userId:t})];case 1:return[2,e.sent()]}})})},t.prototype.request=function(t,e,n,i,r){return void 0===n&&(n={}),void 0===r&&(r={}),p(this,void 0,void 0,function(){var o,s,a,c;return v(this,function(f){switch(f.label){case 0:for(s in r.Accept="application/json",this.hasToken&&(r.Authorization="Bearer "+this.token),o=[],n)o.push("".concat(s,"=").concat(n[s]));return a=o.length>0?"?".concat(o.join("&")):"",c={headers:r},i&&(c.body=i),[4,w[t]("".concat(this.endpoint).concat(e).concat(a),c)];case 1:return[2,f.sent().data]}})})},t.prototype.logout=function(){this.token=void 0,B().removeItem(V),this.unregisterPingService()},t.prototype.registerPingService=function(t){var e=this;void 0===t&&(t=15e3),this.unregisterPingService(),this.keepOnlineInterval=setInterval(function(){return e.request("get","/auth")},t)},t.prototype.unregisterPingService=function(){clearInterval(this.keepOnlineInterval)},t}(),J=function(){function t(){}return t.prototype.setState=function(t){return this.state.decode(t)},t.prototype.getState=function(){return this.state},t.prototype.patch=function(t){return this.state.decode(t)},t.prototype.teardown=function(){var t,e;null===(e=null===(t=this.state)||void 0===t?void 0:t.$changes)||void 0===e||e.root.clearRefs()},t.prototype.handshake=function(t,e){this.state?new L.Reflection().decode(t,e):this.state=L.Reflection.decode(t,e)},t}(),q=function(){function t(){}return t.prototype.setState=function(t){},t.prototype.getState=function(){return null},t.prototype.patch=function(t){},t.prototype.teardown=function(){},t.prototype.handshake=function(t){},t}();D.schema=J,D.none=q,t.Auth=z,t.Client=H,t.Room=U,t.SchemaSerializer=J,t.registerSerializer=function(t,e){D[t]=e},Object.defineProperty(t,"__esModule",{value:!0})}(e)}}]);